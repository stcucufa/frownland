<!DOCTYPE html>
<html>
    <head>
        <title>Seq.dur</title>
        <meta charset="utf8">
        <link rel="stylesheet" href="test.css">
        <script type="module">

import { test } from "./test.js";
import { K } from "../lib/util.js";
import { Instant, Delay, Par, Seq, dump } from "../lib/score.js";
import { Tape } from "../lib/tape.js";
import { Deck } from "../lib/deck.js";

test("Seq(xs).dur(d) duration", t => {
    t.equal(Seq().dur(29).duration, 29, "empty seq");
    t.equal(
        Seq([Delay(51), Delay(23), Delay(31), Delay(17), Delay(19)]).dur(179).duration, 179,
        "more than natural duration"
    );
    t.equal(
        Seq([Delay(51), Delay(23), Delay(31), Delay(17), Delay(19)]).dur(79).duration, 79,
        "less than natural duration"
    );
    t.equal(
        Seq([Delay(51), Delay(23).repeat()]).dur(179).duration, 179,
        "indefinite natural duration"
    );
    t.equal(
        Seq([Delay(51), Delay(23), Delay(31), Par.map(), Par.map()]).dur(179).duration, 179,
        "unresolved natural duration"
    );
});

test("Extending duration", t => {
    const seq = Tape().instantiate(Seq([Instant(), Delay(23), Delay(19)]).dur(51), 17);
    t.equal(dump(seq),
`* Seq-0 [17, 68[
  * Instant-1 @17
  * Delay-2 [17, 40[
  * Delay-3 [40, 59[`, "dump matches");
});

test("Extending duration (indefinite duration)", t => {
    const seq = Tape().instantiate(Seq([Instant(), Delay(23), Delay(19)]).dur(Infinity), 17);
    t.equal(dump(seq),
`* Seq-0 [17, âˆž[
  * Instant-1 @17
  * Delay-2 [17, 40[
  * Delay-3 [40, 59[`, "dump matches");
});

test("Extending duration (no children)", t => {
    const tape = Tape();
    const noChildren = tape.instantiate(Seq().dur(23), 17);
    const emptyList = tape.instantiate(Seq([]).dur(23), 17);
    Deck({ tape }).now = 41;
    t.equal(dump(noChildren), "* Seq-0 [17, 40[ <undefined>", "no children");
    t.equal(dump(emptyList), "* Seq-1 [17, 40[ <undefined>", "empty list");
});

test("Extending duration (but constrained by parent)", t => {
    const seq = Tape().instantiate(Seq([Instant(), Delay(23), Delay(19)]).dur(71), 17, 51);
    t.equal(dump(seq),
`* Seq-0 [17, 68[
  * Instant-1 @17
  * Delay-2 [17, 40[
  * Delay-3 [40, 59[`, "dump matches");
});

test("Cutting off duration (dur)", t => {
    const seq = Tape().instantiate(Seq([Instant(), Delay(23), Delay(19)]).dur(31), 17);
    t.equal(dump(seq),
`* Seq-0 [17, 48[
  * Instant-1 @17
  * Delay-2 [17, 40[
  * Delay-3 [40, 48[`, "dump matches");
});

test("Cutting off duration (parent duration)", t => {
    const seq = Tape().instantiate(Seq([Instant(), Delay(23), Delay(19)]), 17, 31);
    t.equal(dump(seq),
`* Seq-0 [17, 48[
  * Instant-1 @17
  * Delay-2 [17, 40[
  * Delay-3 [40, 48[`, "dump matches");
});

test("dur(0)", t => {
    const seq = Tape().instantiate(Seq([Instant(), Delay(0), Par(), Delay(23), Instant()]).dur(0), 17);
    t.equal(dump(seq),
`* Seq-0 @17
  * Instant-1 @17
  * Instant-2 @17
  * Par-3 @17
  * Delay-4 @17`, "dump matches");
});

test("dur(0) with only zero-duration children", t => {
    const seq = Tape().instantiate(Seq([Instant(), Delay(0), Par()]).dur(0), 17);
    t.equal(dump(seq),
`* Seq-0 @17
  * Instant-1 @17
  * Instant-2 @17
  * Par-3 @17`, "dump matches");
});

test("Seq.take(n).dur(d), cutting off the duration", t => {
    const tape = Tape();
    const seq = tape.instantiate(Seq([
        Instant(K("A")), Delay(23), Instant(x => x + "*"), Delay(31), Instant(x => x + "*")
    ]).take(3).dur(19), 17);
    Deck({ tape }).now = 37;
    t.equal(dump(seq),
`* Seq-0 [17, 36[ <A>
  * Instant-1 @17 <A>
  * Delay-2 [17, 36[ <A>`, "dump matches");
});

test("Seq.take(n).dur(d), extending the duration", t => {
    const tape = Tape();
    const seq = tape.instantiate(Seq([
        Instant(K("A")), Delay(23), Instant(x => x + "A"), Delay(31), Instant(x => x + "*")
    ]).take(3).dur(39), 17);
    Deck({ tape }).now = 57;
    t.equal(dump(seq),
`* Seq-0 [17, 56[ <AA>
  * Instant-1 @17 <A>
  * Delay-2 [17, 40[ <A>
  * Instant-3 @40 <AA>`, "dump matches");
});

        </script>
    </head>
    <body>
        <p><a href="index.html">Back</a></p>
    </body>
</html>
