<!DOCTYPE html>
<html>
    <head>
        <title>DOMEvent</title>
        <meta charset="utf8">
        <link rel="stylesheet" href="test.css">
        <script type="module">

import { test } from "./test.js";
import { K, timeout } from "../lib/util.js";
import { DOMEvent, Instant, Delay, Par, Seq, dump } from "../lib/score.js";
import { Tape } from "../lib/tape.js";
import { Deck } from "../lib/deck.js";

test("DOMEvent(target, event)", t => {
    const item = DOMEvent(window, "synth");
    t.match(item.show(), /Event<[^,]+, synth>/, `show (${item.show()})`);
    t.undefined(item.duration, "unresolved duration");
    t.equal(!item.failible, true, "infailible (at instantiation)");
});

test("Instantiation", t => {
    const tape = Tape();
    const deck = Deck({ tape });
    const instance = tape.instantiate(DOMEvent(window, "synth"), 17);
    deck.now = 27;
    const event = new Event("synth");
    window.dispatchEvent(event);
    t.equal(instance.value, event, "instance value");
    t.match(dump(instance), /^\* DOMEvent-0 \[17, 27\[ <[^>]+>$/, "dump matches");
});

test("Repeat", t => {
    const tape = Tape();
    const deck = Deck({ tape });
    const seq = tape.instantiate(Seq([
        DOMEvent(window, "synth").repeat().take(3),
        Instant(K("ok"))
    ]), 17);
    deck.now = 27;
    window.dispatchEvent(new Event("synth"));
    deck.now = 37;
    window.dispatchEvent(new Event("synth"));
    deck.now = 47;
    window.dispatchEvent(new Event("synth"));
    deck.now = 48;
    t.match(dump(seq), /^\* Seq-0 \[17, 47\[ <ok>\n  \* Seq\/repeat-1 \[17, 47\[ <[^>]+>\n    \* DOMEvent-2 \[17, 27\[ <[^>]+>\n    \* DOMEvent-3 \[27, 37\[ <[^>]+>\n    \* DOMEvent-4 \[37, 47\[ <[^>]+>\n  \* Instant-5 @47 <ok>$/, "dump matches");
});

test("Cancel", t => {
    const tape = Tape();
    const deck = Deck({ tape });
    const instance = tape.instantiate(Par([
        Seq([Instant(K([19])), Par.map(Delay)]),
        DOMEvent(window, "synth")
    ]).take(1), 17);
    deck.now = 37;
    t.equal(dump(instance),
`* Par-0 [17, 36[ <19>
  * Seq-1 [17, 36[ <19>
    * Instant-2 @17 <19>
    * Par/map-3 [17, 36[ <19>
      * Delay-5 [17, 36[ <19>
  * DOMEvent-4 [17, 36[ (cancelled)`, "dump matches");
});

test("Prune", t => {
    const tape = Tape();
    const deck = Deck({ tape });
    const choice = tape.instantiate(Par([
        Seq([Instant(K([19])), Par.map(Delay)]),
        Seq([Delay(23), DOMEvent(window, "synth")]),
    ]).take(1), 17);
    deck.now = 37;
    t.equal(dump(choice),
`* Par-0 [17, 36[ <19>
  * Seq-1 [17, 36[ <19>
    * Instant-2 @17 <19>
    * Par/map-3 [17, 36[ <19>
      * Delay-7 [17, 36[ <19>
  * Seq-4 [17, 36[ (cancelled)
    * Delay-5 [17, 36[ (cancelled)`, "dump matches");
    t.equal(tape.show(), "Tape<17,17,36>", "occurrences were removed from the tape");
});

        </script>
    </head>
    <body>
        <p><a href="index.html">Back</a></p>
    </body>
</html>
