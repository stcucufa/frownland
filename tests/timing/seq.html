<!DOCTYPE html>
<html>
    <head>
        <title>Seq</title>
        <meta charset="utf8">
        <link rel="stylesheet" href="../test.css">
        <script type="module">

import { test } from "../test.js";
import { K } from "../../lib/util.js";
import { Instant, Delay, Seq } from "../../lib/timing.js";

test("Seq(...children)", t => {
    const i = Instant(K("ok"));
    const d = Delay(23);
    const seq = Seq(i, d);
    t.equal(seq.tag, "Seq", "tag");
    t.equal(seq.children, [i, d], "children");
});

test("Code generation", t => {
    const seq = Seq(Delay(23), Instant((x, t) => {
        if (x === null) {
            return t * 2;
        }
    }));
    const thread = { stack: [null], ops: [[17]] };
    seq.generate(thread);
    t.equal(thread.ops.length, 2, "Execution with duration");
    t.equal(thread.ops[0].length, 3, "Begin seq, begin delay");
    t.equal(thread.ops[0][1](thread), seq, "Op for begin seq");
    t.equal(thread.ops[1].length, 4, "End delay, instant, end seq");
    t.equal(thread.ops[1][0], 40, "End time");
    t.equal(thread.ops[1][3](thread), seq, "Op for end seq");

    for (const [t, ...ops] of thread.ops) {
        thread.t = t;
        for (const op of ops) {
            op(thread);
        }
    }
    t.equal(thread.stack, [80], "Seq value");
});

        </script>
    </head>
    <body>
        <p><a href="../index.html">Back</a></p>
    </body>
</html>
