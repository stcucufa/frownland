<!DOCTYPE html>
<html>
    <head>
        <title>Seq</title>
        <meta charset="utf8">
        <link rel="stylesheet" href="../test.css">
        <script type="module">

import { test } from "../test.js";
import { K } from "../../lib/util.js";
import { Instant, Delay, Seq } from "../../lib/timing.js";
import { Thread, VM } from "../../lib/runtime.js";

test("Seq(...children)", t => {
    const i = Instant(K("ok"));
    const d = Delay(23);
    const seq = Seq(i, d);
    t.equal(seq.tag, "Seq", "tag");
    t.equal(seq.children, [i, d], "children");
});

test("Code generation", t => {
    const seq = Seq(Delay(23), Instant((x, t) => t * (x ?? 2)));
    const vm = VM();
    const thread = vm.add(seq, 17);
    t.equal(thread.ops.length, 4, "begin seq, delay, instant, end seq");
    t.equal(thread.ops[0](thread), seq, "op for begin seq");
    t.equal(thread.ops[3](thread), seq, "op for end seq");
    vm.run(thread);
    t.equal(thread.t, thread.end, `end time (${thread.t})`);
    t.equal(thread.value, 80, "end value");
});

test("Code generation (empty seq)", t => {
    const seq = Seq();
    const vm = VM();
    const thread = vm.add(seq, 17);
    t.equal(thread.ops.length, 2, "begin seq, end seq");
    vm.run(thread);
    t.equal(thread.end, 17, "end time");
    t.undefined(thread.value, "end value");
});

test("Code generation (constrained duration)", t => {
    const seq = Seq(Delay(23), Instant((x, t) => t * (x ?? 2)));
    const thread = Thread();
    t.equal(seq.generate(thread, 17, 19), 40, "cutoff");
    t.equal(thread.ops.length, 3, "begin seq, delay (padding), end seq");
    VM().run(Object.assign(thread, { t: 17 }));
    t.equal(thread.t, 36, "end time constrained by dur");
});

test("dur (shorter)", t => {
    const seq = Seq(Delay(23), Instant(K("ok"))).dur(19);
    const vm = VM();
    const thread = vm.add(seq, 17);
    t.equal(thread.end, 36, "end time constrained by dur");
    vm.run(thread);
    t.undefined(thread.value, "seq value");
});

test("dur (longer)", t => {
    const seq = Seq(Delay(23), Instant(K("ok"))).dur(29);
    const vm = VM();
    const thread = vm.add(seq, 17);
    t.equal(thread.end, 46, "end time set by dur");
    vm.run(thread);
    t.equal(thread.t, 46, "end time");
    t.equal(thread.value, "ok", "seq value");
});

test("maximum duration", t => {
    const seq = Seq(Delay(23), Instant(K("ok"))).durMax(19);
    const vm = VM();
    const thread = vm.add(seq, 17);
    t.equal(thread.end, 36, "end time constrained by dur");
    vm.run(thread);
    t.undefined(thread.value, "seq value");
});

test("minimum duration", t => {
    const seq = Seq(Delay(23), Instant(K("ok"))).durMin(29);
    const vm = VM();
    const thread = vm.add(seq, 17);
    t.equal(thread.end, 46, "end time set by dur");
    vm.run(thread);
    t.equal(thread.t, 46, "end time");
    t.equal(thread.value, "ok", "seq value");
});

test("duration between", t => {
    const seq = Seq(Delay(23), Instant((x, t) => t * (x ?? 2))).durBetween(19, 29);
    const vm = VM();
    const thread = vm.add(seq, 17);
    t.equal(thread.end, 40, "end time as set by dur");
    vm.run(thread);
    t.equal(thread.t, 40, "end time");
    t.equal(thread.value, 80, "end value");
});

        </script>
    </head>
    <body>
        <p><a href="../index.html">Back</a></p>
    </body>
</html>
