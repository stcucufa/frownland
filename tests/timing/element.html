<!DOCTYPE html>
<html>
    <head>
        <title>Element</title>
        <meta charset="utf8">
        <link rel="stylesheet" href="../test.css">
        <script type="module">

import { test } from "../test.js";
import { html, K } from "../../lib/util.js";
import { Tape } from "../../lib/tape.js";
import { Deck } from "../../lib/deck.js";
import { Delay } from "../../lib/timing/delay.js";
import { Element } from "../../lib/timing/element.js";
import { Event } from "../../lib/timing/event.js";
import { Instant } from "../../lib/timing/instant.js";
import { Par } from "../../lib/timing/par.js";
import { Seq } from "../../lib/timing/seq.js";
import { dump } from "../../lib/timing/util.js";

test("Element(element, parent, context)", t => {
    const element = Element(html("p", "Hello"));
    t.equal(element.show(), "Element<P>", "show");
    t.equal(element.duration, 0, "zero duration");
    t.equal(!element.fallible, true, "not fallible");
});

test("Instantiation (zero duration)", t => {
    const tape = Tape();
    const instance = tape.instantiate(Element(html("p", "Hello")), 17);
    Deck({ tape }).now = 18;
    t.match(dump(instance), /^\* Element-0 @17 <[^>]+>$/, "dump matches");
});

test("Instantiation (non-zero duration)", t => {
    const tape = Tape();
    const instance = tape.instantiate(Element(html("p", "Hello")).dur(23), 17);
    Deck({ tape }).now = 41;
    t.match(dump(instance), /^\* Element-0 \[17, 40\[ <[^>]+>$/, "dump matches");
});

test("Element().dur()", t => {
    const tape = Tape();
    const instance = tape.instantiate(Seq(
        Element(html("p", "ok")).dur(23),
        Instant(element => element.textContent)
    ), 17);
    Deck({ tape }).now = 41;
    t.match(dump(instance), /^\* Seq-0 \[17, 40\[ <ok>\n  \* Element-1 \[17, 40\[ <[^>]+>\n  \* Instant-2 @40 <ok>$/, "dump matches");
});

test("Cancel", t => {
    const tape = Tape();
    const deck = Deck({ tape });
    const wait = html("p", "wait");
    const par = tape.instantiate(Par(
        Par(Event(window, "synth"), Delay(23)),
        Element(wait).dur(Infinity)
    ).take(1), 17);
    deck.now = 31;
    window.dispatchEvent(new window.Event("synth"));
    deck.now = 41;
    t.match(dump(par), /^\* Par-0 \[17, 40\[ <\[[^\]]+\],>\n  \* Par-1 \[17, 40\[ <\[[^\]]+\],>\n    \* Event-2 \[17, 31\[ <[^>]+>\n    \* Delay-3 \[17, 40\[ <undefined>\n  \* Element-4 \[17, 40\[ \(cancelled\)$/, "dump matches");
    t.equal(wait.parentElement, null, "element was removed");
});

test("Prune", t => {
    const tape = Tape();
    const instance = tape.instantiate(Par(
        Seq(Instant(K([23])), Par.map(Delay)),
        Seq(Delay(31), Element(html("p", "ok")).dur(Infinity))
    ).take(1), 17);
    Deck({ tape }).now = 41;
    t.equal(dump(instance),
`* Par-0 [17, 40[ <23>
  * Seq-1 [17, 40[ <23>
    * Instant-2 @17 <23>
    * Par/map-3 [17, 40[ <23>
      * Delay-7 [17, 40[ <23>
  * Seq-4 [17, 40[ (cancelled)
    * Delay-5 [17, 40[ (cancelled)`, "dump matches");
    t.equal(tape.show(), "Tape<17,17,40>", "occurrences were removed from the tape");
});

        </script>
    </head>
    <body>
        <p><a href="../index.html">Back</a></p>
    </body>
</html>
