<!DOCTYPE html>
<html>
    <head>
        <title>Par</title>
        <meta charset="utf8">
        <link rel="stylesheet" href="../test.css">
        <script type="module">

import { test } from "../test.js";
import { K, typeOf } from "../../lib/util.js";
import { Instant, Delay, Par } from "../../lib/timing.js";
import { Thread, VM } from "../../lib/runtime.js";

test("Par(...children)", t => {
    const i = Instant(K("ok"));
    const d = Delay(23);
    const par = Par(i, d);
    t.equal(par.tag, "Par", "tag");
    t.equal(par.children, [i, d], "children");
});

test("Code generation", t => {
    const par = Par(Instant(K("ok")), Delay(23));
    const vm = VM();
    const thread = vm.add(par, 17);
    t.equal(thread.ops.length, 4, "begin par, two new threads, end par");
    t.equal(typeOf(thread.ops[1].ops), "array", "ops for first thread");
    t.equal(typeOf(thread.ops[2].ops), "array", "ops for second thread");
    vm.run(thread);
    t.equal(thread.t, thread.end, `end time (${thread.t})`);
    t.equal(thread.value, ["ok", undefined], "end value");
});

test("Code generation (empty par)", t => {
    const par = Par();
    const vm = VM();
    const thread = vm.add(par, 17);
    t.equal(thread.ops.length, 2, "begin par, end par");
    vm.run(thread);
    t.equal(thread.end, 17, "end time");
    t.equal(thread.value, [], "end value");
});

test("Code generation (constrained duration)", t => {
    const par = Par(Instant(K("ok")), Delay(23));
    const thread = Thread();
    t.equal(par.generate(thread, 17, 19), 36, "constrained end");
    t.equal(thread.ops.length, 4, "begin par, two new threads, end par");
    t.equal(thread.ops[1].ops.length, 1, "ops for first thread (instant)");
    t.equal(thread.ops[2].ops.length, 0, "no ops for second thread (cut off delay)");
});

        </script>
    </head>
    <body>
        <p><a href="../index.html">Back</a></p>
    </body>
</html>
